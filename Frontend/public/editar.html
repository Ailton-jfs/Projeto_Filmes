<!DOCTYPE html>
<html lang="pt-BR">
<head>
ย <meta charset="UTF-8" />
ย <meta name="viewport" content="width=device-width, initial-scale=1.0" />
ย <title>Editar Perfil - Cine+</title>
ย <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white font-sans min-h-screen">

ย <header class="fixed w-full top-0 z-20 bg-black/80 backdrop-blur-md px-8 py-4 flex justify-between items-center border-b border-gray-800">
ย ย <button onclick="voltar()" class="text-gray-400 hover:text-white transition">&larr; Voltar</button>
ย ย <h1 class="text-2xl font-bold text-red-600">Editar Perfil</h1>
ย ย <div></div>
ย </header>

ย <main class="pt-24 flex justify-center items-center">
ย ย <div class="bg-gray-900/70 backdrop-blur-md p-10 rounded-2xl shadow-2xl max-w-lg w-full mx-4">
ย ย ย <h2 class="text-3xl font-bold mb-6 text-center">โ๏ธ Editar Perfil</h2>

ย ย ย <form id="formEditar" class="space-y-4">
ย ย ย ย <input type="text" id="nome" placeholder="Nome" required
ย ย ย ย ย class="w-full p-3 rounded-lg bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-600 transition" />
ย ย ย ย 
ย ย ย ย <input type="email" id="email" placeholder="E-mail" required
ย ย ย ย ย class="w-full p-3 rounded-lg bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-600 transition" />
ย ย ย ย 
ย ย ย ย <input type="password" id="senha" placeholder="Nova senha (opcional)"
ย ย ย ย ย class="w-full p-3 rounded-lg bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-600 transition" />

ย ย ย ย <button type="submit"
ย ย ย ย ย class="w-full bg-red-600 hover:bg-red-700 py-3 rounded-lg text-lg font-semibold transition">
ย ย ย ย ย Salvar Alteraรงรตes
ย ย ย ย </button>
ย ย ย </form>

ย ย ย <p id="mensagem" class="mt-4 text-center text-sm"></p>
ย ย </div>
ย </main>

ย <script>
ย ย const API_BASE = "http://localhost:3000/api/usuarios";
ย ย const form = document.getElementById("formEditar");
ย ย const msg = document.getElementById("mensagem");

ย ย function voltar() {
ย ย ย window.location.href = "perfil.html";
ย ย }

ย ย document.addEventListener("DOMContentLoaded", () => {
ย ย ย // ๐ CORREรรO: Pegando o usuรกrio logado usando a chave correta: "dadosUsuario"
ย ย ย const usuario = JSON.parse(localStorage.getItem("dadosUsuario"));

ย ย ย if (!usuario || !usuario.id) {
ย ย ย ย // Redireciona se nรฃo estiver logado
ย ย ย ย window.location.href = "login.html";
ย ย ย ย return;
ย ย ย }

ย ย ย // Preenche os campos com os dados atuais
ย ย ย document.getElementById("nome").value = usuario.nome;
ย ย ย document.getElementById("email").value = usuario.email;

ย ย ย form.addEventListener("submit", async (e) => {
ย ย ย ย e.preventDefault();

ย ย ย ย const nome = document.getElementById("nome").value.trim();
ย ย ย ย const email = document.getElementById("email").value.trim();
ย ย ย ย const senha = document.getElementById("senha").value.trim();

ย ย ย ย if (!nome || !email) {
ย ย ย ย ย msg.textContent = "Preencha nome e e-mail.";
ย ย ย ย ย msg.className = "text-red-500 text-center mt-4";
ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย const body = { nome, email };
ย ย ย ย if (senha) body.senha = senha;

ย ย ย ย try {
ย ย ย ย ย // Endpoint PATCH correto, usando o ID do objeto de usuรกrio
ย ย ย ย ย const response = await fetch(`${API_BASE}/${usuario.id}`, {
ย ย ย ย ย ย method: "PATCH",
ย ย ย ย ย ย headers: { "Content-Type": "application/json" },
ย ย ย ย ย ย body: JSON.stringify(body)
ย ย ย ย ย });

ย ย ย ย ย if (!response.ok) {
ย ย ย ย ย ย const data = await response.json();
ย ย ย ย ย ย msg.textContent = data.erro || "Erro ao atualizar perfil.";
ย ย ย ย ย ย msg.className = "text-red-500 text-center mt-4";
ย ย ย ย ย ย return;
ย ย ย ย ย }

ย ย ย ย ย const updated = await response.json();
ย ย ย ย ย // ๐ CORREรรO: Atualiza o localStorage com os novos dados nas chaves corretas
ย ย ย ย ย localStorage.setItem("dadosUsuario", JSON.stringify(updated));
ย ย ย ย ย localStorage.setItem("usuario", updated.nome); // Atualiza o nome para o menu da navbar

ย ย ย ย ย msg.textContent = "โ Perfil atualizado com sucesso!";
ย ย ย ย ย msg.className = "text-green-400 text-center mt-4";

ย ย ย ย ย setTimeout(() => window.location.href = "perfil.html", 1000);

ย ย ย ย } catch (err) {
ย ย ย ย ย msg.textContent = "Erro de conexรฃo com o servidor.";
ย ย ย ย ย msg.className = "text-red-500 text-center mt-4";
ย ย ย ย }
ย ย ย });
ย ย });
ย </script>

</body>
</html>