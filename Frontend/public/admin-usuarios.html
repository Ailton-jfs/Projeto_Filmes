<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usu√°rios Admin | Cine+</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal-overlay { background: rgba(0, 0, 0, 0.75); display: none; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <header class="bg-gray-800 p-4 shadow-lg flex justify-between items-center">
        <h1 class="text-xl font-bold text-red-500">Painel Admin</h1>
        <nav class="flex gap-4">
            <a href="admin-dashboard.html" class="text-gray-400 hover:text-white">Dashboard</a>
            <a href="admin-usuarios.html" class="text-white hover:text-red-400 font-semibold">Usu√°rios</a>
            <button id="logoutAdmin" class="text-red-400 hover:text-red-500">üö™ Sair</button>
        </nav>
    </header>

    <main class="p-8">
        <h2 class="text-3xl font-bold mb-6">Gerenciamento de Usu√°rios</h2>

        <div class="bg-gray-800 rounded-lg shadow-xl overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Nome</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Email</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Cadastro</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="usuariosTableBody" class="divide-y divide-gray-800">
                    <tr>
                        <td colspan="6" class="p-4 text-center text-gray-400">Carregando usu√°rios...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>
    
    <div id="editUserModal" class="fixed inset-0 modal-overlay items-center justify-center z-50">
        <div class="bg-gray-900 p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h3 class="text-2xl font-bold mb-6 text-red-500">‚úèÔ∏è Editar Usu√°rio <span id="editUserIdDisplay"></span></h3>
            <form id="editUserForm" class="space-y-4">
                <input type="hidden" id="editUserId">
                
                <div>
                    <label for="editNome" class="block text-sm font-medium text-gray-300">Nome</label>
                    <input type="text" id="editNome" required
                           class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                </div>
                
                <div>
                    <label for="editEmail" class="block text-sm font-medium text-gray-300">E-mail</label>
                    <input type="email" id="editEmail" required
                           class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="editIsAdmin" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-600 rounded bg-gray-700">
                    <label for="editIsAdmin" class="ml-2 block text-sm text-gray-300">Conceder Acesso Admin</label>
                </div>
                
                <p id="editMessage" class="text-sm text-red-400 hidden"></p>
                
                <div class="flex justify-end gap-4">
                    <button type="button" id="closeEditModal"
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-md font-semibold transition">
                        Cancelar
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md font-semibold transition">
                        Salvar Altera√ß√µes
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script>
        const API_BASE_URL = "http://localhost:3000/api/admin/usuarios";
        const token = localStorage.getItem('adminToken');
        const usuariosTableBody = document.getElementById('usuariosTableBody');
        const editUserModal = document.getElementById('editUserModal');
        const editUserForm = document.getElementById('editUserForm');
        const closeEditModal = document.getElementById('closeEditModal');
        const editMessage = document.getElementById('editMessage');

        // 1. üõ°Ô∏è Prote√ß√£o de Rota Frontend
        if (!token) {
            window.location.href = 'index.html';
        }
        
        // 2. Fun√ß√£o de Logout
        document.getElementById('logoutAdmin').addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            window.location.href = 'index.html';
        });

        // 3. üìÑ Fun√ß√£o de Busca (READ)
        async function fetchUsuarios() {
            try {
                const response = await fetch(API_BASE_URL, {
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                         localStorage.removeItem('adminToken');
                         alert("Sess√£o expirada. Fa√ßa login novamente.");
                         window.location.href = 'index.html';
                    }
                    throw new Error('Falha ao buscar usu√°rios');
                }

                const usuarios = await response.json();
                renderTable(usuarios);

            } catch (error) {
                usuariosTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-400">Erro ao carregar lista de usu√°rios. Verifique o servidor.</td></tr>`;
                console.error('Erro ao buscar usu√°rios:', error);
            }
        }

        // 4. Renderiza a Tabela (Chamando handleEdit)
        function renderTable(usuarios) {
            if (usuarios.length === 0) {
                usuariosTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-400">Nenhum usu√°rio cadastrado.</td></tr>`;
                return;
            }

            usuariosTableBody.innerHTML = usuarios.map(usuario => {
                const isAdmin = usuario.is_admin ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-800 text-red-300">ADMIN</span>' : 'Comum';
                const createdAt = new Date(usuario.createdAt).toLocaleDateString('pt-BR');
                
                return `
                    <tr class="hover:bg-gray-700">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-300">${usuario.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-white">${usuario.nome}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${usuario.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${isAdmin}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${createdAt}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="handleEdit(${usuario.id})" class="text-indigo-400 hover:text-indigo-600 mr-2">Editar</button>
                            <button onclick="handleDelete(${usuario.id})" class="text-red-400 hover:text-red-600">Excluir</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 5. ‚ùå Fun√ß√£o de Exclus√£o (DELETE) - Mantida
        async function handleDelete(id) {
            if (!confirm(`Tem certeza que deseja excluir o usu√°rio ID ${id}? Esta a√ß√£o √© irrevers√≠vel.`)) return;

            try {
                const response = await fetch(`${API_BASE_URL}/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert(`Usu√°rio ID ${id} exclu√≠do com sucesso!`);
                    fetchUsuarios(); 
                } else {
                    const data = await response.json();
                    alert(`Erro ao excluir: ${data.erro || 'Erro desconhecido.'}`);
                    if (response.status === 401 || response.status === 403) {
                         localStorage.removeItem('adminToken');
                         window.location.href = 'index.html';
                    }
                }
            } catch (error) {
                alert('Erro de conex√£o com o servidor ao tentar excluir.');
            }
        }

        // 6. ‚úèÔ∏è Fun√ß√µes de Edi√ß√£o (PUT) - NOVO
        closeEditModal.addEventListener('click', () => {
            editUserModal.style.display = 'none';
        });

        // Fun√ß√£o para carregar dados no modal
        async function handleEdit(id) {
            editMessage.classList.add('hidden');
            editUserModal.style.display = 'flex';
            document.getElementById('editUserIdDisplay').textContent = `(#${id})`;
            document.getElementById('editUserId').value = id;
            
            try {
                const response = await fetch(`${API_BASE_URL}/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const usuario = await response.json();
                    document.getElementById('editNome').value = usuario.nome;
                    document.getElementById('editEmail').value = usuario.email;
                    document.getElementById('editIsAdmin').checked = usuario.is_admin;
                } else {
                    const data = await response.json();
                    editMessage.textContent = data.erro || "Erro ao carregar dados do usu√°rio.";
                    editMessage.classList.remove('hidden');
                }
            } catch (error) {
                editMessage.textContent = 'Erro de conex√£o ao buscar dados.';
                editMessage.classList.remove('hidden');
            }
        }

        // Fun√ß√£o para enviar os dados atualizados
        editUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            editMessage.classList.add('hidden');

            const id = document.getElementById('editUserId').value;
            const nome = document.getElementById('editNome').value;
            const email = document.getElementById('editEmail').value;
            const isAdmin = document.getElementById('editIsAdmin').checked;
            
            const payload = { nome, email, is_admin: isAdmin };

            try {
                const response = await fetch(`${API_BASE_URL}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert(`Usu√°rio ID ${id} atualizado com sucesso!`);
                    editUserModal.style.display = 'none';
                    fetchUsuarios(); // Recarrega a lista
                } else {
                    const data = await response.json();
                    editMessage.textContent = data.erro || 'Erro ao salvar altera√ß√µes.';
                    editMessage.classList.remove('hidden');
                }
            } catch (error) {
                editMessage.textContent = 'Erro de conex√£o ao tentar salvar.';
                editMessage.classList.remove('hidden');
            }
        });

        // Inicia o carregamento dos dados ao abrir a p√°gina
        fetchUsuarios();
    </script>
</body>
</html>